<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨ | THE GIANT</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --bg: #0b0f19;
    --card: #111827;
    --accent: #00b2ff;
    --muted: #ccc;
    --success: #00c851;
    --danger: #ff4444;
}

body {
    font-family: "Cairo", sans-serif;
    background: var(--bg);
    color: #fff;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
    color: var(--accent);
    font-size: 30px;
    margin-bottom: 15px;
}

.back-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 18px;
    background: var(--accent);
    color: #000;
    font-weight: bold;
    border-radius: 10px;
    text-decoration: none;
    transition: .25s;
}
.back-btn:hover { background: #0095e5; }

.profile-card {
    background: var(--card);
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    border-right: 5px solid var(--accent);
    margin-bottom: 25px;
}

.section-title {
    font-size: 22px;
    color: var(--accent);
    font-weight: 700;
    margin-bottom: 10px;
    margin-top: 25px;
}

.info-row {
    padding: 10px;
    background: #0e1724;
    border-radius: 10px;
    margin-bottom: 8px;
    font-size: 17px;
}

.status-badge {
    padding: 3px 8px;
    border-radius: 8px;
    font-weight: bold;
}
.yes { background: var(--success); color: #fff; }
.no { background: var(--danger); }

.course-box {
    background: #0e1724;
    padding: 15px;
    border-radius: 15px;
    margin-bottom: 15px;
    border-right: 3px solid var(--accent);
}

.course-name {
    font-size: 19px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 8px;
}

.results-box {
    margin-top: 8px;
    padding: 10px;
    background: #1a2332;
    border-radius: 10px;
    font-size: 15px;
}

ul { padding-right: 20px; }
li { margin-bottom: 6px; }

.loading {
    text-align: center;
    font-size: 20px;
    margin-top: 20px;
    color: var(--muted);
}
</style>
</head>
<body>

<a href="details.html" class="back-btn">â¬… Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
<h1>ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨</h1>

<div id="profileContainer" class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, get, ref } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
    authDomain: "ylearn-fe1fa.firebaseapp.com",
    databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
    projectId: "ylearn-fe1fa",
    storageBucket: "ylearn-fe1fa.appspot.com",
    messagingSenderId: "1092852055944",
    appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const container = document.getElementById("profileContainer");

const params = new URLSearchParams(window.location.search);
const uid = params.get("id");

if (!uid) {
    container.innerHTML = "<p style='color:red'>Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø·Ø§Ù„Ø¨.</p>";
    throw new Error("No user id provided.");
}

// ----- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© -----
onAuthStateChanged(auth, (user) => {
    const ADMIN_UID = "lSpi591awfQMcRFU62CAM3108Hu1";

    if (!user) {
        window.location.href = "login.html";
        return;
    }

    // ÙÙ‚Ø· Ø§Ù„Ø£Ø¯Ù…Ù† Ø£Ùˆ Ù†ÙØ³ Ø§Ù„Ù€ UID ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ù„Ù
    if (user.uid !== ADMIN_UID && user.uid !== uid) {
        alert("ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
        window.location.href = "index.html";
        return;
    }

    loadProfile();
});

async function loadProfile() {
    try {
        const userSnap = await get(ref(db, `users/${uid}`));
        const studentSnap = await get(ref(db, `students/${uid}/purchased`));
        const coursesSnap = await get(ref(db, "courses"));
        const examsSnap = await get(ref(db, `results/${uid}`));
        const hwSnap = await get(ref(db, `homeworkResult/${uid}`));

        if (!userSnap.exists()) {
            container.innerHTML = "<p style='text-align:center;color:red'>Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.</p>";
            return;
        }

        const user = userSnap.val();
        const purchased = studentSnap.exists() ? studentSnap.val() : {};
        const courses = coursesSnap.exists() ? coursesSnap.val() : {};
        const examResults = examsSnap.exists() ? examsSnap.val() : {};
        const homeworkResults = hwSnap.exists() ? hwSnap.val() : {};

        container.innerHTML = `
            <div class="profile-card">
                <div class="section-title">ğŸ“Œ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©</div>
                <div class="info-row">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${user.fullName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</div>
                <div class="info-row">ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: ${user.studentNumber || "-"}</div>
                <div class="info-row">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${user.parentNumber || "-"}</div>
                <div class="info-row">ğŸ“ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${user.grade || "-"}</div>
            </div>
            <div class="section-title">ğŸ“˜ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</div>
        `;

        const purchasedCourses = Object.keys(purchased);

        if (purchasedCourses.length === 0) {
            container.innerHTML += "<p style='color:#bbb;text-align:center'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ù…Ø´ØªØ±Ùƒ Ø¨Ù‡Ø§.</p>";
            return;
        }

        purchasedCourses.forEach(cid => {
            const course = courses[cid] || {};
            const courseName = course.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";

            const examDone = examResults[cid] ? true : false;
            const hwDone = homeworkResults[cid] ? true : false;

            container.innerHTML += `
                <div class="course-box">
                    <div class="course-name">ğŸ“— ${courseName}</div>

                    <div class="results-box">
                        <p>ğŸ“Œ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:
                            ${examDone ? "<span class='status-badge yes'>âœ” ØªÙ… Ø§Ù„Ø­Ù„</span>" : "<span class='status-badge no'>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ù„</span>"}
                        </p>

                        <p>ğŸ“Œ Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨:
                            ${hwDone ? "<span class='status-badge yes'>âœ” ØªÙ… Ø§Ù„Ø­Ù„</span>" : "<span class='status-badge no'>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ù„</span>"}
                        </p>

                        ${
                            examDone ? `
                            <p style="margin-top:10px;font-weight:bold">ğŸ“„ Ù†ØªÙŠØ¬Ø© Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù†:</p>
                            <ul>
                                <li>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${examResults[cid].score || 0}</li>
                                <li>Ø§Ù„Ù†Ø³Ø¨Ø©: ${examResults[cid].percentage || 0}%</li>
                                <li>ğŸ•’ Ø§Ù„Ø²Ù…Ù†: ${examResults[cid].timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©</li>
                            </ul>
                            ` : ""
                        }

                        ${
                            hwDone ? `
                            <p style="margin-top:10px;font-weight:bold">ğŸ“ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨:</p>
                            <ul>
                                <li>Ø§Ù„Ø¯Ø±Ø¬Ø©: ${homeworkResults[cid].score || 0}</li>
                                <li>Ø§Ù„Ù†Ø³Ø¨Ø©: ${homeworkResults[cid].percentage || 0}%</li>
                                <li>ğŸ•’ Ø§Ù„Ø²Ù…Ù†: ${homeworkResults[cid].timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©</li>
                            </ul>
                            ` : ""
                        }
                    </div>
                </div>
            `;
        });
    } catch (err) {
        console.error("Error loading profile:", err);
        container.innerHTML = "<p style='color:red;text-align:center'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>";
    }
}
</script>

</body>
</html>