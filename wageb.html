<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ğŸ“˜ Ø§Ù„ÙˆØ§Ø¬Ø¨ - Ù…Ù†ØµØ© THE GIANT</title>
<style>
  body {margin:0;font-family:"Cairo",sans-serif;background:#0b0f19;color:#fff;min-height:100vh;}
  header {background:#111827;padding:1rem 1.5rem;display:flex;justify-content:center;align-items:center;box-shadow:0 0 10px rgba(0,0,0,0.4);}
  header h1 {color:#00b2ff;margin:0;font-size:1.2rem;}
  .exam-container {max-width:950px;margin:auto;padding:1rem;}
  .exam-title {text-align:center;font-size:1.4rem;color:#00b2ff;margin:1.5rem 0 1.5rem;}
  .stats-bar {display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:1.5rem;}
  .stat-card {padding:1rem;border-radius:12px;text-align:center;font-weight:bold;font-size:0.9rem;box-shadow:0 0 10px rgba(0,0,0,0.3);}
  .blue{background:#007bff;} .green{background:#28a745;} .red{background:#dc3545;} .yellow{background:#ffc107;color:#000;} .purple{background:#6f42c1;}
  .question-card{background:#1e2636;padding:1rem;border-radius:10px;margin-bottom:1rem;}
  .question-card h3{margin-top:0;color:#00b2ff;}
  .options label{display:block;background:#2a3245;margin:0.5rem 0;padding:0.6rem;border-radius:8px;cursor:pointer;transition:0.3s;}
  .options label:hover{background:#3a4560;}
  textarea {width:100%;padding:0.6rem;margin-top:0.5rem;border-radius:8px;background:#2a3245;color:#fff;border:none;resize:vertical;min-height:110px;}
  .submit-btn{background:#00b2ff;border:none;color:white;padding:0.7rem 1.2rem;border-radius:10px;cursor:pointer;font-size:1rem;display:block;width:100%;margin-top:1.2rem;}
  .submit-btn:hover{opacity:0.9;}
  .result-card{background:#1e2636;padding:1.5rem;border-radius:10px;margin-top:1.5rem;text-align:center;}
  .result-card h2{color:#00b2ff;margin-bottom:1rem;}
  .correct-answer{color:#28a745;font-weight:bold;margin-top:5px;}
  .wrong-answer{color:#dc3545;font-weight:bold;margin-top:5px;}
  .model-answer{background:#0f1720;padding:0.8rem;border-radius:8px;margin-top:8px;color:#ddd;font-size:0.95rem;}
  .student-answer{background:#0b1320;padding:0.8rem;border-radius:8px;margin-top:8px;color:#fff;font-size:0.95rem;white-space:pre-wrap;}
</style>
</head>
<body>
  <header><h1>ğŸ“˜ Ø§Ù„ÙˆØ§Ø¬Ø¨</h1></header>
  <div class="exam-container">
    <div id="examTitle" class="exam-title">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ø¨...</div>
    <div class="stats-bar">
      <div class="stat-card purple">ğŸ§© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <span id="totalQ">0</span></div>
      <div class="stat-card yellow">ğŸ“ Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©: <span id="answeredQ">0</span></div>
      <div class="stat-card green">âœ”ï¸ Ø§Ù„ØµØ­ÙŠØ­Ø©: <span id="correctQ">0</span></div>
      <div class="stat-card red">âŒ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: <span id="wrongQ">0</span></div>
      <div class="stat-card blue">â± Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timer">--:--</span></div>
      <div class="stat-card blue">â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: <span id="elapsedTime">0:00</span></div>
    </div>

    <form id="examForm"></form>
    <div id="resultSection"></div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDW80ZbwOB7QHHW76kSL9cqlzMoyPFZ7nI",
  authDomain: "ylearn-fe1fa.firebaseapp.com",
  databaseURL: "https://ylearn-fe1fa-default-rtdb.firebaseio.com",
  projectId: "ylearn-fe1fa",
  storageBucket: "ylearn-fe1fa.firebasestorage.app",
  messagingSenderId: "1092852055944",
  appId: "1:1092852055944:web:85c3df7cf4c0cbcdca043d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
await setPersistence(auth, browserLocalPersistence);

// params: Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…: courses -> content -> homeworkId
const params = new URLSearchParams(window.location.search);
let homeworkId = params.get("homeworkId") || localStorage.getItem("currentHomeworkId");
if (homeworkId) localStorage.setItem("currentHomeworkId", homeworkId);
else {
  alert("âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
  document.getElementById("examTitle").textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ø¨.";
}

const examTitleEl = document.getElementById("examTitle");
const examForm = document.getElementById("examForm");
const resultSection = document.getElementById("resultSection");
const totalQEl = document.getElementById("totalQ");
const answeredQEl = document.getElementById("answeredQ");
const correctQEl = document.getElementById("correctQ");
const wrongQEl = document.getElementById("wrongQ");
const timerEl = document.getElementById("timer");
const elapsedEl = document.getElementById("elapsedTime");

let timerInterval = null, elapsedInterval = null, totalSeconds = 0, startTime = Date.now();

function pad(n){ return n.toString().padStart(2,"0"); }

function startCountdown(seconds){
  totalSeconds = seconds;
  const update = () => {
    const m = Math.floor(totalSeconds/60);
    const s = totalSeconds%60;
    timerEl.textContent = `${m}:${pad(s)}`;
  };
  update();
  timerInterval = setInterval(()=>{
    if (totalSeconds <= 0) {
      clearInterval(timerInterval);
      autoFinish();
    } else {
      totalSeconds--;
      update();
    }
  },1000);
}

function startElapsed(){
  startTime = Date.now();
  elapsedInterval = setInterval(()=>{
    const diff = Math.floor((Date.now()-startTime)/1000);
    const m = Math.floor(diff/60);
    const s = diff%60;
    elapsedEl.textContent = `${m}:${pad(s)}`;
  },1000);
}

function gradeEssay(studentAnswer, modelAnswer) {
  if (!studentAnswer || !modelAnswer) return false;
  const clean = (text) => text.replace(/[^\u0600-\u06FF0-9 A-Za-zØ¡-ÙŠ]/g, " ").trim().split(/\s+/);
  const studentWords = clean(studentAnswer);
  const modelWords = clean(modelAnswer);
  if (studentWords.length === 0) return false;
  let matchCount = 0;
  studentWords.forEach(w => { if (modelWords.includes(w)) matchCount++; });
  const similarity = matchCount / studentWords.length;
  return similarity >= 0.70;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "login.html";

  const uid = user.uid;

  const prev = await get(ref(db, `homeworkResult/${uid}/${homeworkId}`));
  if (prev.exists()) {
    const r = prev.val();
    examTitleEl.textContent = `${r.title || "Ø§Ù„ÙˆØ§Ø¬Ø¨"} - ØªÙ… Ø§Ù„Ø­Ù„ âœ…`;
    examForm.innerHTML = "";
    resultSection.innerHTML = `
      <div class="result-card">
        <h2>ğŸ¯ ØªÙ… Ø­Ù„ Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹</h2>
        <p>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${r.name || r.studentName || user.displayName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"}</p>
        <p>ğŸ“ Ø§Ù„Ø±Ù‚Ù…: ${r.phone || r.studentPhone || "-"}</p>
        <p>ğŸ“± Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${r.parentPhone || "-"}</p>
        <p>âœ… ØµØ­ÙŠØ­Ø©: ${r.correct}</p>
        <p>âŒ Ø®Ø§Ø·Ø¦Ø©: ${r.wrong}</p>
        <p>Ø§Ù„Ù†Ø³Ø¨Ø©: ${r.percentage || 0}%</p>
        <p>â³ Ø§Ù„Ø²Ù…Ù†: ${r.timeTakenMin || 0} Ø¯Ù‚ÙŠÙ‚Ø©</p>
        <button class="submit-btn" onclick="window.location.href='dashboard.html'">ğŸ  Ø§Ù„Ø±Ø¬ÙˆØ¹</button>
      </div>`;
    return;
  }

  const snap = await get(ref(db, "courses"));
  if (!snap.exists()) {
    examTitleEl.textContent = "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª/Ù…Ø­ØªÙˆÙ‰ Ø­Ø§Ù„ÙŠØ§Ù‹.";
    return;
  }

  let hw = null;
  snap.forEach(courseSnap=>{
    const content = courseSnap.child("content");
    content.forEach(cSnap=>{
      if (cSnap.key === homeworkId) {
        hw = cSnap.val();
      }
    });
  });

  if (!hw) {
    examTitleEl.textContent = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ§Ø¬Ø¨.";
    return;
  }

  examTitleEl.textContent = hw.title || "ÙˆØ§Ø¬Ø¨";
  const questions = hw.questions || {};
  const timeMinutes = hw.time || 10;
  startCountdown(timeMinutes * 60);
  startElapsed();

  totalQEl.textContent = Object.keys(questions).length;
  examForm.innerHTML = "";

  Object.entries(questions).forEach(([qid, q])=>{
    const div = document.createElement("div");
    div.className = "question-card";

    if ((q.type && q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ") || q.opt1 || q.opt2 || q.opt3 || q.opt4) {
      div.innerHTML = `
        <h3>${q.question}</h3>
        <small style="color:#bbb">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${q.mark || 1}</small>
        <div class="options">
          ${[q.opt1,q.opt2,q.opt3,q.opt4].filter(Boolean).map(opt=>`<label><input type="radio" name="${qid}" value="${opt}"> ${opt}</label>`).join("")}
        </div>
      `;
    } else {
      div.innerHTML = `
        <h3>${q.question}</h3>
        <small style="color:#bbb">Ø§Ù„Ø¯Ø±Ø¬Ø©: ${q.mark || 1}</small>
        <textarea name="${qid}" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      `;
    }
    examForm.appendChild(div);
  });

  const submitBtn = document.createElement("button");
  submitBtn.className = "submit-btn";
  submitBtn.type = "button";
  submitBtn.textContent = "ğŸ“¤ ØªØ³Ù„ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ø¨";
  submitBtn.onclick = () => finishHomework(user, questions, hw.title || "ÙˆØ§Ø¬Ø¨");
  examForm.appendChild(submitBtn);

  examForm.addEventListener("input", ()=>{
    let answered = 0;
    Object.keys(questions).forEach(id=>{
      const q = questions[id] || {};
      if (q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ" || (q.opt1||q.opt2||q.opt3||q.opt4)) {
        if (document.querySelector(`input[name="${id}"]:checked`)) answered++;
      } else {
        const ta = document.querySelector(`textarea[name="${id}"]`);
        if (ta && ta.value.trim()) answered++;
      }
    });
    answeredQEl.textContent = answered;
  });
});

async function finishHomework(user, questions, title) {
  clearInterval(timerInterval);
  clearInterval(elapsedInterval);

  const uid = user.uid;
  let correct = 0, wrong = 0;
  const answers = {};

  for (const [id, q] of Object.entries(questions)) {

    const correctAnswer = q.modelAnswer || q.correct || "";   // ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§

    const isMCQ = (q.type === "Ø§Ø®ØªÙŠØ§Ø±ÙŠ" || q.opt1 || q.opt2 || q.opt3 || q.opt4);

    if (isMCQ) {
      const chosen = document.querySelector(`input[name="${id}"]:checked`);
      const card = document.querySelector(`input[name='${id}']`) ? document.querySelector(`input[name='${id}']`).closest(".question-card") : null;
      const value = chosen ? chosen.value : null;

      answers[id] = { type: "Ø§Ø®ØªÙŠØ§Ø±ÙŠ", answer: value || null };

      if (value && value === correctAnswer) {   // ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        correct += (q.mark || 1);
        if (card) card.innerHTML += `<div class='correct-answer'>âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©</div>`;
      } else {
        wrong++;
        if (card) card.innerHTML += `<div class='wrong-answer'>âŒ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctAnswer}</div>`;  // ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      }

    } else {

      const ta = document.querySelector(`textarea[name="${id}"]`);
      const studentAnswer = ta ? ta.value.trim() : "";
      answers[id] = { type: "Ù…Ù‚Ø§Ù„ÙŠ", answer: studentAnswer || null, model: correctAnswer };
      const card = ta ? ta.closest(".question-card") : null;

      if (studentAnswer) {
        const isCorrect = gradeEssay(studentAnswer, correctAnswer);   // ğŸ”¥ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

        if (isCorrect) {
          correct += (q.mark || 1);
          if (card) {
            card.innerHTML += `<div class='correct-answer'>âœ… Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù‚Ø§Ù„ÙŠØ© Ù…Ù‚Ø¨ÙˆÙ„Ø©</div>
                               <div class="model-answer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©: ${correctAnswer}</div>
                               <div class="student-answer">Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentAnswer}</div>`;
          }
        } else {
          wrong++;
          if (card) {
            card.innerHTML += `<div class='wrong-answer'>âŒ Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù‚Ø§Ù„ÙŠØ© ØºÙŠØ± ÙƒØ§ÙÙŠØ©</div>
                               <div class="model-answer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©: ${correctAnswer}</div>
                               <div class="student-answer">Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentAnswer}</div>`;
          }
        }
      } else {
        wrong++;
        if (card) {
          card.innerHTML += `<div class='wrong-answer'>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</div>
                             <div class="model-answer">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©: ${correctAnswer}</div>`;
        }
      }
    }
  }

  correctQEl.textContent = correct;
  wrongQEl.textContent = wrong;

  const totalMarks = Object.values(questions).reduce((s,q)=> s + (q.mark || 1), 0);
  const totalQuestions = Object.keys(questions).length;
  const timeTakenSec = Math.floor((Date.now() - startTime)/1000);
  const timeTakenMin = (timeTakenSec/60).toFixed(1);
  const percentage = ((correct / totalMarks) * 100).toFixed(1);

  examForm.style.display = "none";

  resultSection.innerHTML = `
    <div class="result-card">
      <h2>ğŸ¯ Ù†ØªÙŠØ¬ØªÙƒ</h2>
      <p>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${totalQuestions}</p>
      <p>Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø© (Ø¨Ø§Ù„Ø¹Ù„Ø§Ù…Ø©): ${correct}</p>
      <p>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©: ${wrong}</p>
      <p>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${correct} / ${totalMarks}</p>
      <p>Ø§Ù„Ù†Ø³Ø¨Ø©: ${percentage}%</p>
      <p>â³ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø³ØªØºØ±Ù‚: ${timeTakenMin} Ø¯Ù‚ÙŠÙ‚Ø©</p>
      <button class="submit-btn" onclick="window.location.href='dashboard.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
    </div>
  `;

  const userSnap = await get(ref(db, `users/${uid}`));
  const u = userSnap.exists() ? userSnap.val() : {};

  const data = {
    uid,
    name: u.fullName || user.displayName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
    studentName: u.fullName || user.displayName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
    phone: u.studentNumber || u.phoneNumber || null,
    studentPhone: u.studentNumber || u.phoneNumber || null,
    parentPhone: u.parentNumber || null,
    title,
    examTitle: title,
    score: correct,
    total: totalMarks,
    correct,
    wrong,
    totalQuestions,
    percentage,
    timeTakenMin,
    answers,
    createdAt: Date.now(),
    finishedAt: new Date().toISOString()
  };

  await set(ref(db, `homeworkResult/${uid}/${homeworkId}`), data);

  alert("ğŸ’¬ THE GIANT says: ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªÙŠØ¬ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ¯");
}

async function autoFinish(){
  const { getAuth } = await import("https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js");
  const currentUser = getAuth().currentUser;
  if (!currentUser) {
    window.location.href = "login.html";
    return;
  }
  const snap = await get(ref(db, "courses"));
  if (!snap.exists()) {
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.");
    return;
  }
  let hw = null;
  snap.forEach(courseSnap=>{
    const content = courseSnap.child("content");
    content.forEach(cSnap=>{
      if (cSnap.key === homeworkId) hw = cSnap.val();
    });
  });
  const questions = hw ? (hw.questions || {}) : {};
  await finishHomework(currentUser, questions, hw ? (hw.title || "ÙˆØ§Ø¬Ø¨") : "ÙˆØ§Ø¬Ø¨");
}
</script>
</body>
</html>